<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comment List with Reply Feature</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        #comment-content, #reply-content {
            white-space : pre-wrap;
        }
    </style>
</head>
<body>
<div class="container">
    <table class="table">
        <tbody th:if="${comment.commentId} == ${comment.parentComment.id}" th:each="comment : ${commentList}">
        <div>
            <tr>
                <td th:text="${comment.authorName}">작성자</td>
            </tr>
            <tr>
                <td th:text="${comment.createdAt}">작성일</td>
            </tr>
            <tr>
                <td id="comment-content" colspan="3" th:text="${comment.content}">내용</td>
            </tr>
            <tr>
                <td>
                    <button type="button" class="btn btn-success reply-button" th:data-comment-id="${comment.commentId}">답글</button>
                </td>
                <td>
                    <a class="btn btn-warning update-button">수정</a>
                    <a class="btn btn-secondary delete-button">삭제</a>
                </td>
            </tr>

            <tr class="reply-form-row" style="display:none;" th:if="${reply.commentId} != ${reply.parentComment.id} and ${comment.commentId} == ${reply.parentComment.id}" th:each="reply : ${commentList}">
                <td colspan="3" class="reply-comment" style="padding-left: 20px;">
                    <div>
                        <span th:text="${reply.authorName}">작성자</span>
                        <span th:text="${reply.createdAt}">작성일</span>
                        <p id="reply-content" th:text="${reply.content}">내용</p>
                        <a class="btn btn-warning update-button">수정</a>
                        <a class="btn btn-secondary delete-button">삭제</a>
                    </div>
                    <div class="reply-form-container"></div>
                </td>
            </tr>
        </div>
        </tbody>
    </table>
</div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll(".reply-button").forEach(button => {
            button.addEventListener("click", function(event) {
                const commentId = this.getAttribute('data-comment-id');
                const replyRow = this.closest('tr').nextElementSibling;
                const replyFormContainer = replyRow.querySelector('.reply-form-container');

                if (replyRow.style.display === 'none') {
                    // AJAX request to load commentInput.html
                    fetch('/comments/commentInput.html')
                        .then(response => response.text())
                        .then(html => {
                            replyFormContainer.innerHTML = html;
                            // Set the parent comment ID
                            const parentIdInput = replyFormContainer.querySelector('#parentId');
                            if (parentIdInput) {
                                parentIdInput.value = commentId;
                            }
                            // Show the reply form row
                            replyRow.style.display = 'table-row';

                            // Add event listener for the reply form submission
                            const form = replyFormContainer.querySelector('form');
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();
                                const formData = new FormData(form);
                                fetch('/api/comments/new', {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Reply posted:', data);
                                        // Here you can update the UI to show the new reply
                                        // For example, you could reload the entire comment section
                                        location.reload();
                                    })
                                    .catch(error => console.error('Error:', error));
                            });
                        })
                        .catch(error => console.error('Error:', error));
                } else {
                    // Hide the reply form
                    replyRow.style.display = 'none';
                    replyFormContainer.innerHTML = '';
                }
            });
        });
    });
</script>
</html>
